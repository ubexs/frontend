"use strict";function _createForOfIteratorHelper(a,b){var c;if("undefined"==typeof Symbol||null==a[Symbol.iterator]){if(Array.isArray(a)||(c=_unsupportedIterableToArray(a))||b&&a&&"number"==typeof a.length){c&&(a=c);var d=0,e=function(){};return{s:e,n:function n(){return d>=a.length?{done:!0}:{done:!1,value:a[d++]}},e:function e(a){throw a},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var f,g=!0,h=!1;return{s:function s(){c=a[Symbol.iterator]()},n:function n(){var a=c.next();return g=a.done,a},e:function e(a){h=!0,f=a},f:function f(){try{g||null==c["return"]||c["return"]()}finally{if(h)throw f}}}}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}var statuses={1:"<span class=\"badge badge-warning\">Pending Support Response</span>",2:"<span class=\"badge badge-dark\">Pending Customer Response</span>",3:"<span class=\"badge badge-success\">Closed</span>",4:"<span class=\"badge badge-warning\">Staff Need More Time</span>"},searchStatus=$(".ticket-search-mode").val(),sleep=function(a){return new Promise(function(b){setTimeout(b,a)})};$(document).on("change",".ticket-search-mode",function(a){a.preventDefault();var b=$(this).val();searchStatus=b,loadTickets()});var currentTicketsResponse=[],loadTickets=function(){var a="/staff/support/tickets?status="+searchStatus;request(a,"GET").then(function(a){currentTicketsResponse=a;var b=$("#tickets").empty();if(0===a.length)return b.append("<p>Thare are no tickets at this time.</p>");var c,d=[],e=_createForOfIteratorHelper(a);try{for(e.s();!(c=e.n()).done;){var f=c.value;d.push(f.userId),b.append("\n                <div class=\"row\" style=\"margin-bottom:0.5rem;\">\n                    <div class=\"col-12\">\n                        <div class=\"card\">\n                            <div class=\"card-body\">\n                                <div class=\"ticket-click\" data-ticket-id=\"".concat(f.ticketId,"\" data-open=\"false\" style=\"cursor:pointer;\">\n                                    <div class=\"row\">\n                                        <div class=\"col-8 ticket-overview\">\n                                            <p style=\"font-weight: bold\">").concat(f.ticketTitle,"</p>\n                                            <p style=\"font-size:0.75rem;\">Created ").concat(moment(f.createdAt).fromNow(),"</p>\n                                            <p style=\"font-size:0.75rem;\">By <a href=\"/staff/user/profile?userId=").concat(f.userId,"\"><span data-userid=\"").concat(f.userId,"\">Loading...</span></a></p>\n                                        </div>\n                                        <div class=\"col-4\">\n                                            <p style=\"text-align:right;\">").concat(statuses[f.ticketStatus],"</p>\n                                        </div>\n                                    </div>\n                                    <div class=\"row ticket-data-row\"></div>\n                                </a>\n                            </div>\n                        </div>\n                    </div>  \n                </div>\n                \n                "))}}catch(a){e.e(a)}finally{e.f()}setUserNames(d)})["catch"](function(a){console.error("fetch tickets error",a)})};loadTickets(),$(document).on("click",".ticket-close",function(a){a.preventDefault();var b=$(this).parent().parent().parent();return"true"===$(b).attr("data-loading")?void console.log("loading"):void("true"===$(b).attr("data-open")&&(console.log("empty"),$(b).find("div.row.ticket-data-row").first().empty(),$(b).attr("data-open","false"),$(b).attr("data-loading","true"),setTimeout(function(){$(b).attr("data-loading","false")},500),$(b).css("cursor","pointer"),$(this).remove()))}),$(document).on("click","div.ticket-click",function(){var a=this;console.log("ticket click");var b=parseInt($(this).attr("data-ticket-id"),10),c=currentTicketsResponse.filter(function(a){return a.ticketId===b})[0]||{};if("true"!==$(this).attr("data-loading")){var d="true"===$(this).attr("data-open");if(d){return void console.log("is open");// Close it
}else{console.log("is closed"),$(this).css("cursor","default"),$(this).find(".ticket-overview").first().append("<span class=\"badge badge-warning ticket-close\" style=\"cursor:pointer;\">Hide Replies</span>"),$(this).css("opacity","0.5").attr("data-open","true").attr("data-loading","true");var e=$(this).find("div.row.ticket-data-row").first(),f=e.append("<div class=\"col-12 ticket-meta\" style=\"margin-top:1rem;\"></div>").find(".ticket-meta");f.append("\n        \n            <p class=\"support-ticket-text-box\">".concat(c.ticketBody,"</p>\n            <hr />\n        \n        "));var g=e.append("<div class=\"col-12 ticket-replies\"></div>").find(".ticket-replies");Promise.all([sleep(250),request("/staff/support/ticket/"+b+"/replies","GET").then(function(a){if(0===a.length)g.append("\n                            <p>There are 0 replies to this ticket.</p>\n                    ");else{var c,d=[],e=_createForOfIteratorHelper(a);try{for(e.s();!(c=e.n()).done;){var f=c.value;d.push(f.userId),g.append("\n                        \n                        <p style=\"font-weight:bold;font-size:0.85rem;margin-bottom:0.5rem;\">\n                        <a href=\"/staff/user/profile?userId=".concat(f.userId,"\"><span data-userid=\"").concat(f.userId,"\">Loading...</span></a> on ").concat(moment(f.createdAt).format("MMM DD YYYY"),":</p>\n                        <p class=\"support-ticket-text-box\" style=\"margin:1rem;\">").concat(f.ticketBody,"</p>\n                        <hr />\n                        \n                        "))}}catch(a){e.e(a)}finally{e.f()}setUserNames(d)}g.append("\n                <br>\n                <h4>REPLY</h4>\n                <textarea class=\"form-control reply-body\" data-id=\"".concat(b,"\" rows=\"4\" placeholder=\"Reply Text.\" maxlength=\"4096\"></textarea>\n                <div class=\"row\" style=\"margin-top:1rem;\">\n                    <div class=\"col-6\">\n                        <p style=\"font-weight:bold;font-size:0.85rem;\">Reply Mode<p>\n                        <select class=\"form-control hide-reply\" data-id=\"").concat(b,"\">\n                            <option value=\"true\">Show Reply to customer</option>\n                            <option value=\"false\">Hide Reply from customer</option>\n                        </select>\n                    </div>\n                    <div class=\"col-6\">\n                        <p style=\"font-weight:bold;font-size:0.85rem;\">Ticket Status<p>\n                        <select class=\"form-control reply-mode-on-ticket\" data-id=\"").concat(b,"\">\n                            <option value=\"2\">Require Customer Response</option>\n                            <option value=\"4\">Require More Time</option>\n                            <option value=\"3\">Close</option>\n                        </select>\n                    </div>\n                    <div class=\"col-12\" style=\"margin-top:1rem\">\n                        <button class=\"btn btn-success submit-reply\" data-id=\"").concat(b,"\">Submit</button>\n                    </div>\n                </div>\n                \n                "))})])["finally"](function(){$(a).css("opacity","1").attr("data-loading","false")})}}}),$(document).on("click",".submit-reply",function(a){a.preventDefault(),loading();var b=$(this).attr("data-id"),c=$(".reply-body[data-id=\""+b+"\"]").val(),d=$(".reply-mode-on-ticket[data-id=\"".concat(b,"\"]")).val(),e=$(".hide-reply[data-id=\"".concat(b,"\"]")).val(),f=[];f.push(request("/staff/support/ticket/"+b+"/status","PATCH",{status:d})),c&&f.push(request("/staff/support/ticket/"+b+"/reply","POST",{body:c,visibleToClient:e})),Promise.all(f).then(function(){window.location.reload()})["catch"](function(a){warning(a.responseJSON.message)})});